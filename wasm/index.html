<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BinLing 3D Lattice</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: monospace;
            color: #00ff00;
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            pointer-events: none;
        }

        .stat {
            margin-bottom: 5px;
            font-size: 14px;
            text-shadow: 0 0 5px #00ff00;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
    <div id="hud">
        <div class="stat">STATUS: <span id="status">CONNECTING...</span></div>
        <div class="stat">CYCLE: <span id="cycle">0</span></div>
        <div class="stat">CELLS: <span id="count">0</span></div>
        <div class="stat" style="color: #888; margin-top: 10px;">[LEFT CLICK]: Rotate | [SCROLL]: Zoom</div>
    </div>
    <div id="canvas-container"></div>

    <script>
        // --- 1. SETUP 3D WORLD ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.02);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(20, 20, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040); // Soft white light
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 1, 100);
        pointLight.position.set(10, 10, 10);
        scene.add(pointLight);

        // Geometry Cache
        const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);

        // Materials (Standard + Royal Trinity + Oracle)
        const matGreen = new THREE.MeshBasicMaterial({ color: 0x2ea043, transparent: true, opacity: 0.9 }); // Core
        const matBlue = new THREE.MeshBasicMaterial({ color: 0x58a6ff, transparent: true, opacity: 0.6 }); // Shell
        const matRed = new THREE.MeshBasicMaterial({ color: 0xf85149, transparent: true, opacity: 0.4 }); // Skin
        const matGrey = new THREE.MeshBasicMaterial({ color: 0x333333, transparent: true, opacity: 0.2 }); // Static

        // MACF Materials (The Undercity)
        const matGold = new THREE.MeshBasicMaterial({ color: 0xffd700, transparent: false });              // Queen (Solid Gold)
        const matSilver = new THREE.MeshBasicMaterial({ color: 0xc0c0c0, transparent: true, opacity: 0.8 }); // Prince (Silver)
        const matCyan = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.8 }); // Scepter (Cyan)
        const matPurple = new THREE.MeshBasicMaterial({ color: 0x9d4edd, transparent: true, opacity: 0.9 }); // Oracle (Purple)

        // Group to hold all cells
        const latticeGroup = new THREE.Group();
        scene.add(latticeGroup);

        // --- 2. CONNECT TO SERVER ---
        function connect() {
            const socket = new WebSocket("ws://127.0.0.1:8081");
            const statusEl = document.getElementById('status');

            socket.onopen = () => {
                statusEl.innerText = "ONLINE";
                statusEl.style.color = "#00ff00";
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    // Update HUD
                    document.getElementById('cycle').innerText = data.cycle;
                    document.getElementById('count').innerText = data.active_count;

                    // Update 3D Model
                    updateLattice(data.cells);

                } catch (e) { console.error(e); }
            };

            socket.onclose = () => {
                statusEl.innerText = "OFFLINE";
                statusEl.style.color = "#ff0000";
                setTimeout(connect, 2000);
            };
        }

        // --- 3. RENDER LOOP ---
        function updateLattice(cells) {
            // Clear old cells
            while (latticeGroup.children.length > 0) {
                latticeGroup.remove(latticeGroup.children[0]);
            }

            cells.forEach(c => {
                const x = c[0];
                const y = c[1];
                const z = c[2];
                const type = c[3];

                let mat = matGrey;

                // User Space
                if (type === 1) mat = matGreen;
                if (type === 2) mat = matBlue;
                if (type === 3) mat = matRed;

                // System Space (MACF)
                if (type === 4) mat = matGold;   // Queen
                if (type === 5) mat = matSilver; // Prince
                if (type === 6) mat = matCyan;   // Scepter
                if (type === 7) mat = matPurple; // Oracle

                const cube = new THREE.Mesh(geometry, mat);
                cube.position.set(x, y, z);
                latticeGroup.add(cube);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            latticeGroup.rotation.y += 0.002; // Slow auto-spin
            renderer.render(scene, camera);
        }

        // Handle Window Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start
        animate();
        connect();
    </script>
</body>

</html>