<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinLing Lattice</title>
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        h1 {
            color: #58a6ff;
            margin-bottom: 10px;
        }

        #dashboard {
            border: 1px solid #30363d;
            background: #161b22;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            min-width: 300px;
        }

        .metric {
            font-size: 2em;
            font-weight: bold;
            color: #3fb950;
            margin: 20px 0;
        }

        .label {
            font-size: 0.8em;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #status-line {
            margin-top: 20px;
            color: #8b949e;
            font-size: 0.9em;
        }
    </style>
</head>

<body>

    <div id="dashboard">
        <h1>ðŸ§¬ BinLing Web Node</h1>

        <div class="label">Active Organisms</div>
        <div id="cell-count" class="metric">--</div>

        <div class="label">World Age (Cycles)</div>
        <div id="cycle-count" class="metric">--</div>

        <div id="status-line">Initializing WebAssembly Core...</div>
    </div>

    <script type="module">
        import init, { WebLattice } from './pkg/binling_wasm.js';

        async function run() {
            try {
                console.log("Loading WASM...");
                await init();
                console.log("WASM Loaded.");

                const statusDiv = document.getElementById("status-line");
                statusDiv.innerText = "Core Online. Running Simulation.";
                statusDiv.style.color = "#3fb950"; // Green for success

                console.log("Creating Universe...");
                const lattice = new WebLattice();

                const cellCountDiv = document.getElementById("cell-count");
                const cycleCountDiv = document.getElementById("cycle-count");

                // Start Loop
                setInterval(() => {
                    // 1. Tick
                    lattice.tick();

                    // 2. Read Status string from Rust
                    const status = lattice.get_status();

                    // 3. Update UI
                    // Parse "Cycle: 10 | Active: 1..."
                    const parts = status.split('|');
                    if (parts.length > 0) {
                        // Extract number from "Cycle: 123"
                        cycleCountDiv.innerText = parts[0].split(':')[1].trim();
                    }
                    cellCountDiv.innerText = lattice.get_active_cell_count();

                }, 100);

            } catch (e) {
                console.error("CRITICAL FAILURE:", e);
                // Ensure the element exists before trying to write error
                const statusDiv = document.getElementById("status-line");
                if (statusDiv) {
                    statusDiv.innerText = "Error: " + e.message;
                    statusDiv.style.color = "#ff7b72";
                }
            }
        }

        run();
    </script>
</body>

</html>